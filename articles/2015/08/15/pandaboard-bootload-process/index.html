<!DOCTYPE html>
<html lang="en">
<head>

        <title>Pandaboard bootload(uboot) 启动流程探究</title>
        <meta charset="utf-8" />
        <link href="http://blog.kfatso.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kage's Blog Full Atom Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="http://blog.kfatso.com/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="http://blog.kfatso.com/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="http://blog.kfatso.com/theme/pygment.css" />

        <script src="http://blog.kfatso.com/theme/js/libs/modernizr-2.6.2.min.js"></script>

<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>


</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="http://blog.kfatso.com">Kage's Blog <strong>Stay Hungry, Stay Foolish.</strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="/">Home</a></li>

				<li><a href="/functions/archives.html">Archives</a></li>
				<!--
					<li><a href="/functions/tags.html">Tags</a></li>
					<li><a href="/functions/archives.html">Archives</a></li>
				
				-->
              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="http://blog.kfatso.com/articles/2015/08/15/pandaboard-bootload-process/" rel="bookmark"
                   title="Permalink to Pandaboard bootload(uboot) 启动流程探究">Pandaboard bootload(uboot) 启动流程探究</a></h2>
           
            </header>
            <footer class="post-info">
              <!--
			  <abbr class="published" title="2015-08-15T12:00:00+08:00">
                Sat 15 August 2015
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="http://blog.kfatso.com/author/kage-shen.html">Kage Shen</a>
              </address>
			  -->
			  <address class="vcard author" style="font-style:italic;margin-bottom:-10px;">
				Sat 15 August 2015
					&nbsp;&nbsp;Write By <a class="url fn" href="http://blog.kfatso.com/author/kage-shen.html">Kage Shen</a>
	
			  </address>
			  <hr />			  
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <blockquote>
<h3>主要内容:</h3>
<p>之前使用的uboot都是直接编译就可以使用了, 但是作为一个愿意折腾的人, 这样的程度显然不够,<br />
于是一如既往的打开了uboot的代码看起来吧!  </p>
</blockquote>
<h3>准备工作</h3>
<p>1, Linux 64bit 系统电脑一台<br />
2, 熟悉的编译器, 最好有代码引索功能的, 免得找得蛋疼<br />
3, 下载源代码, 及芯片手册  </p>
<h3>引导流程从这里开始</h3>
<p><strong>寻找srart源头:</strong></p>
<p>折腾过ARM的人必然知道, 系统启动前一定有一段汇编代码, 来设置时钟, 看门狗什么的.
通过前面的文章, 我们了解uboot编译后生成了两个东西是我们需要的, MLO和u-boot.img,
u-boot.img大家都知道, MLO是啥呢? 明显这个是omap4460启动时需要的, 而且是会自动
加载的二进制文件(关于omap4460的自启动过程可以参看手册 &lt;27.1 Initialization Overview&gt;),
那么启动的汇编代码应该就在MLO里了吧, 打开uboot代码的 Makefile (./Makefile), 发现  </p>
<div class="highlight"><pre><span></span>./Makefile:1222
spl/u-boot-spl: tools prepare
    <span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="nv">obj</span><span class="o">=</span>spl -f <span class="k">$(</span>srctree<span class="k">)</span>/scripts/Makefile.spl all
</pre></div>


<p>spl在uboot里表示第二阶段启动代码, 其实就是芯片内部代码启动完后, 就会加载spl了,
那估计就是我们说的MLO了, 继续看, MLO必然和 scripts/Makefile.spl 文件有关, 查看之  </p>
<div class="highlight"><pre><span></span>scripts/Makefile.spl:54
libs-<span class="k">$(</span>CONFIG_SPL_FRAMEWORK<span class="k">)</span> +<span class="o">=</span> common/spl/
libs-<span class="k">$(</span>CONFIG_SPL_LIBCOMMON_SUPPORT<span class="k">)</span> +<span class="o">=</span> common/
libs-<span class="k">$(</span>CONFIG_SPL_LIBDISK_SUPPORT<span class="k">)</span> +<span class="o">=</span> disk/
</pre></div>


<p>这里只发现编译选项和编译内容, 貌似没什么线索了, 换一个想法, 编译的时候没看到, 是不是
在连接的时候能够看到点什么呢, 于是飞快敲入:  </p>
<div class="highlight"><pre><span></span><span class="nv">$make</span> <span class="nv">V</span><span class="o">=</span><span class="m">1</span> <span class="p">|</span> grep .lds
   ....
   arm-none-linux-gnueabi-ld     -r -o spl/lib/built-in.o spl/lib/hashtable.o spl/lib/errno.o spl/lib/display_options.o spl/lib/crc32.o spl/lib/ctype.o spl/lib/div64.o spl/lib/hang.o spl/lib/linux_compat.o spl/lib/linux_string.o spl/lib/string.o spl/lib/time.o spl/lib/uuid.o spl/lib/vsprintf.o 

     arm-linux-gnueabihf-gcc -E -Wp,-MD,spl/.u-boot-spl.lds.d -D__KERNEL__ -D__UBOOT__ -DCONFIG_SYS_TEXT_BASE<span class="o">=</span>0x80800000  -DCONFIG_SPL_BUILD  -D__ARM__ -Wa,-mimplicit-it<span class="o">=</span>always  -mthumb -mthumb-interwork  -mabi<span class="o">=</span>aapcs-linux  -mno-unaligned-access  -ffunction-sections -fdata-sections -fno-common -ffixed-r9  -msoft-float  -pipe  -march<span class="o">=</span>armv7-a   -Iinclude    -I./arch/arm/include -include ./include/linux/kconfig.h  -nostdinc -isystem /mnt/ssd/arm-linux-gnueabihf-5.2/bin/../lib/gcc/arm-linux-gnueabihf/5.2.1/include -include ./include/u-boot/u-boot.lds.h -include ./include/config.h -DCPUDIR<span class="o">=</span>arch/arm/cpu/armv7  -ansi -D__ASSEMBLY__ -x assembler-with-cpp -P -o spl/u-boot-spl.lds arch/arm/cpu/armv7/omap-common/u-boot-spl.lds

  <span class="o">(</span><span class="nb">cd</span> spl <span class="o">&amp;&amp;</span> arm-none-linux-gnueabi-ld   -T u-boot-spl.lds  --gc-sections -Bstatic --gc-sections -Ttext 0x40300000 arch/arm/cpu/armv7/start.o --start-group arch/arm/cpu/armv7/built-in.o arch/arm/cpu/built-in.o arch/arm/lib/built-in.o board/ti/panda/built-in.o common/spl/built-in.o common/built-in.o disk/built-in.o drivers/i2c/built-in.o drivers/gpio/built-in.o drivers/mmc/built-in.o drivers/serial/built-in.o fs/built-in.o lib/built-in.o --end-group arch/arm/lib/eabi_compat.o -L /mnt/ssd/arm-2014.05/bin/../lib/gcc/arm-none-linux-gnueabi/4.8.3/thumb2 -lgcc -Map u-boot-spl.map -o u-boot-spl<span class="o">)</span>
   ....
</pre></div>


<p>编译时gcc使用 arch/arm/cpu/armv7/omap-common/u-boot-spl.lds 文件生成了 spl/u-boot-spl.lds <br />
u-boot-spl.lds文件使用了许多宏来控制, 具体可以看看编译时的输出信息.</p>
<div class="highlight"><pre><span></span>arch/arm/cpu/armv7/omap-common/u-boot-spl.lds:0
MEMORY <span class="o">{</span> .sram : <span class="nv">ORIGIN</span> <span class="o">=</span> CONFIG_SPL_TEXT_BASE,<span class="se">\</span>
        <span class="nv">LENGTH</span> <span class="o">=</span> CONFIG_SPL_MAX_SIZE <span class="o">}</span>
MEMORY <span class="o">{</span> .sdram : <span class="nv">ORIGIN</span> <span class="o">=</span> CONFIG_SPL_BSS_START_ADDR, <span class="se">\</span>
        <span class="nv">LENGTH</span> <span class="o">=</span> CONFIG_SPL_BSS_MAX_SIZE <span class="o">}</span>

OUTPUT_FORMAT<span class="o">(</span><span class="s2">&quot;elf32-littlearm&quot;</span>, <span class="s2">&quot;elf32-littlearm&quot;</span>, <span class="s2">&quot;elf32-littlearm&quot;</span><span class="o">)</span>
OUTPUT_ARCH<span class="o">(</span>arm<span class="o">)</span>
ENTRY<span class="o">(</span>_start<span class="o">)</span>
SECTIONS
<span class="o">{</span>
    .text      :
    <span class="o">{</span>
        <span class="nv">__start</span> <span class="o">=</span> .<span class="p">;</span>
        *<span class="o">(</span>.vectors<span class="o">)</span>
        arch/arm/cpu/armv7/start.o  <span class="o">(</span>.text*<span class="o">)</span>
        *<span class="o">(</span>.text*<span class="o">)</span>
    <span class="o">}</span> &gt;.sram
</pre></div>


<div class="highlight"><pre><span></span>spl/u-boot-spl.lds:0
MEMORY <span class="o">{</span> .sram : <span class="nv">ORIGIN</span> <span class="o">=</span> 0x40300000, <span class="nv">LENGTH</span> <span class="o">=</span> <span class="o">(</span>0x4030C000 - 0x40300000<span class="o">)</span> <span class="o">}</span>
MEMORY <span class="o">{</span> .sdram : <span class="nv">ORIGIN</span> <span class="o">=</span> 0x80a00000, <span class="nv">LENGTH</span> <span class="o">=</span> 0x80000 <span class="o">}</span>
OUTPUT_FORMAT<span class="o">(</span><span class="s2">&quot;elf32-littlearm&quot;</span>, <span class="s2">&quot;elf32-littlearm&quot;</span>, <span class="s2">&quot;elf32-littlearm&quot;</span><span class="o">)</span>
OUTPUT_ARCH<span class="o">(</span>arm<span class="o">)</span>
ENTRY<span class="o">(</span>_start<span class="o">)</span>
SECTIONS
<span class="o">{</span>
 .text :
 <span class="o">{</span>
  <span class="nv">__start</span> <span class="o">=</span> .<span class="p">;</span>
  *<span class="o">(</span>.vectors<span class="o">)</span>
  arch/arm/cpu/armv7/start.o <span class="o">(</span>.text*<span class="o">)</span>
  *<span class="o">(</span>.text*<span class="o">)</span>
 <span class="o">}</span> &gt;.sram
 . <span class="o">=</span> ALIGN<span class="o">(</span>4<span class="o">)</span><span class="p">;</span>
 .rodata : <span class="o">{</span> *<span class="o">(</span>SORT_BY_ALIGNMENT<span class="o">(</span>.rodata*<span class="o">))</span> <span class="o">}</span> &gt;.sram
 . <span class="o">=</span> ALIGN<span class="o">(</span>4<span class="o">)</span><span class="p">;</span>
 .data : <span class="o">{</span> *<span class="o">(</span>SORT_BY_ALIGNMENT<span class="o">(</span>.data*<span class="o">))</span> <span class="o">}</span> &gt;.sram
 . <span class="o">=</span> ALIGN<span class="o">(</span>4<span class="o">)</span><span class="p">;</span>
 .u_boot_list : <span class="o">{</span>
  KEEP<span class="o">(</span>*<span class="o">(</span>SORT<span class="o">(</span>.u_boot_list*_i2c_*<span class="o">)))</span><span class="p">;</span>
 <span class="o">}</span> &gt;.sram
 . <span class="o">=</span> ALIGN<span class="o">(</span>4<span class="o">)</span><span class="p">;</span>
 <span class="nv">__image_copy_end</span> <span class="o">=</span> .<span class="p">;</span>
 .end :
 <span class="o">{</span>
  *<span class="o">(</span>.__end<span class="o">)</span>
 <span class="o">}</span>
 .bss :
 <span class="o">{</span>
  . <span class="o">=</span> ALIGN<span class="o">(</span>4<span class="o">)</span><span class="p">;</span>
  <span class="nv">__bss_start</span> <span class="o">=</span> .<span class="p">;</span>
  *<span class="o">(</span>.bss*<span class="o">)</span>
  . <span class="o">=</span> ALIGN<span class="o">(</span>4<span class="o">)</span><span class="p">;</span>
  <span class="nv">__bss_end</span> <span class="o">=</span> .<span class="p">;</span>
 <span class="o">}</span> &gt;.sdram
<span class="o">}</span>
</pre></div>


<p>spl里的0x40300000地址是什么呢?<br />
打开手册我们可以看到: L3 OCM_RAM 0x40300000 56KB 32-bit Ex/R/W<br />
看上去是内部扩展的RAM, 估计是专门用来的boot的, 下面是手册说明.  </p>
<div class="highlight"><pre><span></span>15.1.6.3 L3 OCM_RAM
The on-chip L3 OCM_RAM contains 56KB of RAM, and partitioning is defined by the L3 firewall logic. The
device-embedded L3 OCM_RAM has the following characteristics:
• Support <span class="k">for</span> single and burst access transactions:
– Operates at full L3 interconnect clock frequency
– Fully pipelined, one 32-bit access per cycle
• Restricted access support
</pre></div>


<p>上面定义的两个内存段, 分别是sram, sdram. sram是芯片内部的一段存储区, sdram是DDR
初始化完成后才能使用的地址区域.<br />
.text段代码将全部放在sram中, 其中arch/arm/cpu/armv7/start.o里的.text段代码放在sram的
最开始的地方. 那么start.S就是我们要找的东西啦, 打开一看, 果然就是熟悉而又陌生的汇编代码
映满屏幕, 末要慌张, 听我慢慢分析.</p>
<p><strong>顺流而下, 柳暗花明:</strong></p>
<p>打开start.S文件, 其实里面有很多注释, 已经足够我们去阅读这里的代码, 这里就会有人说了
"里面的汇编代码我不知道具体的含义啊", 很早之前我也会有这样的问题, 但是我发现, 就算我
当时能够很深入的探究, 当时算是相当明白的, 但是时间一久, 都会有遗忘, 看的时候还是要
重新查, 所以我认为, 在没有很必要的时候我是不会区深入查看这些代码的, 能了解大概在做什么
就好了.<br />
这里也想赞一下国外码农的工程意识, 代码写的很有条理, 注释也非常详细, 值得我们学习.  </p>
<p>这里我就列出主要调用流程:  </p>
<pre class="prettyprint">
SPL阶段:
/* Allow the board to save important registers */
b   save_boot_params  // 里实际上就是保存一下函数的返回地址
    |- disable interrupts
    |- b cpu_init_cp15  ---> |- Invalidate L1 I/D  // 无效 指令/数据 缓存
    |                        |- disable MMU        // 方便后续的内存访问, 不需要填写TLB
    |
    |- b cpu_init_crit  ---> |- b lowlevel_init --> |- Setup a temporary stack // 设置SP指针, 估计马上要跑C代码了
    |                                               |- b s_init --> |- init_omap_revision // 获取芯片ID
    |                                                               |- watchdog_init // 初始化看门狗
    |                                                               |- force_emif_self_refresh(); // 初始化DDR
    |                                                               |- setup_clocks_for_console // 开时钟等工作
    |- b _main --> |- setup SP // Set up initial C runtime environment
                   |- board_init_f_mem  // uboot设置内存
                   |- board_init_f      // spl board_init_f
                   |- board_init_r      // spl board_init_r
                   |- spl_load_image
                   |- spl_mmc_load_image
                   |- spl_mmc_do_fs_boot    // 这里把uboot.img放到了 0x80800000上
                   |- jump_to_image_no_args // 跳到uboot上 (0x80800000)

uboot阶段和spl阶段类似, 只是后面有些不一样
    ...

    |- b _main --> |- setup SP // Set up initial C runtime environment
                   |- relocate_code     // 代码从定位
                   |- relocate_vectors  // 设置中断向量
                   |- clear BSS
                   |- ldr pc, =board_init_r // 正式进入uboot地界

相关文件地址:
arch/arm/cpu/armv7/start.S
arch/arm/cpu/armv7/lowlevel_init.S
arch/arm/cpu/armv7/omap-common/hwinit-common.c
arch/arm/lib/crt0.S
arch/arm/lib/board.c
</pre>

<p>上面展示东西不多, 但是包含的东西确是大大滴多啊, 涉及的基础知识很多, 如计算机理论, 编译连接 等, 
是不是瞬间有了"望尽天涯路"的感觉.</p>
<blockquote>
<p>参考资料:<br />
[1]: <a href="http://www.denx.de/wiki/U-Boot">Universal Boot Loader </a><br />
[2]: <a href="http://www.ti.com/product/omap4460">TI omap4460</a>  </p>
</blockquote>
            </div><!-- /.entry-content -->
			
			
			<ul style="float:right;">
				<li>
					◄&nbsp;&nbsp;<a href="http://blog.kfatso.com/articles/2015/08/08/archlinux-setup-quartus-15/">
						Archlinux Setup Quartus II 15.0
					</a>
				</li>
				<li>
					►&nbsp;&nbsp;<a href="http://blog.kfatso.com/articles/2016/01/31/enable-nonessential-clk-gpio/">
						Pandaboard 配置gpio功能 (uboot 2016.1)
					</a>
				</li>
			</ul>
			
			
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "articles/2015/08/15/pandaboard-bootload-process/";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://kgat96.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns">

<div class="sidebarbg">
	<h4>Pages</h4>
	<ul>
		  <li><a href="/functions/tags.html">Tags</a></li>
		  <li><a href="/functions/archives.html">Archives</a></li>
	</ul>
</div>




<div class="social sidebarbg">
	<nav class="widget">
	  <h4>Social</h4>
	  <ul>
		<li><a target="_blank" href="https://github.com/">GitHub</a></li>
		<li><a target="_blank" href="https://www.facebook.com/">FaceBook</a></li>
	  </ul>
	</nav>
</div>

<nav class="widget sidebarbg">
  <h4>Links</h4>
  <ul>
	<li><a target="_blank" href="http://getpelican.com/">Pelican</a></li>
	<li><a target="_blank" href="http://python.org/">Python.org</a></li>
  </ul>
</nav>

</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                <li><div class="btn primary"><a href="https://github.com/" target="_blank">Github</a></div></li>


                <li><div class="btn facebook"><a href="https://www.facebook.com/" target="_blank">Facebook</a></div></li>


              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'kgat96';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="http://blog.kfatso.com/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://blog.kfatso.com/theme/js/libs/gumby.min.js"></script>
  <script src="http://blog.kfatso.com/theme/js/plugins.js"></script>
	<script>
	(function() {
		var $backToTopTxt = "返回顶部", $backToTopEle = $('<div class="backToTop"></div>').appendTo($("body"))
			.text($backToTopTxt).attr("title", $backToTopTxt).click(function() {
				$("html, body").animate({ scrollTop: 0 }, 120);
		}), $backToTopFun = function() {
			var st = $(document).scrollTop(), winh = $(window).height();
			(st > 0)? $backToTopEle.show(): $backToTopEle.hide();
			//IE6下的定位
			if (!window.XMLHttpRequest) {
				$backToTopEle.css("top", st + winh - 166);
			}
		};
		$(window).bind("scroll", $backToTopFun);
		$(function() { $backToTopFun(); });
	})();
	</script>
</body>
</html>